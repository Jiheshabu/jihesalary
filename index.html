<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>薪資小幫手 App</title>
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 引入 Babel 用來解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS 進行樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* 修復 iOS 上輸入框字體大小自動縮放的問題 */
        input, select, textarea {
            font-size: 16px !important;
        }
        /* 隱藏捲軸但保持功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- SVG Icons Components ---
        const CalculatorIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 text-blue-600"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
        );

        const ClockIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-3 h-3"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        );

        const ChevronDownIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="m6 9 6 6 6-6"/></svg>
        );

        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        );

        // --- 子組件 (移到外部以修復 focus 問題) ---
        const TimeInput = ({ value, onChange, onBlur, placeholder }) => (
            <div className="relative w-full">
                <input
                    type="text"
                    list="valid-times"
                    value={value}
                    onChange={onChange}
                    onBlur={onBlur}
                    onFocus={(e) => {
                        // 當獲得焦點時，將該元素捲動到畫面中央，避免被底部總結欄遮擋
                        // 使用 setTimeout 確保瀏覽器預設行為執行後再進行修正
                        setTimeout(() => {
                            e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100);
                    }}
                    placeholder={placeholder}
                    className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-200 transition-shadow bg-white text-gray-900 placeholder-gray-400"
                />
                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                    <ClockIcon />
                </div>
            </div>
        );

        const TaiwanSalaryApp = () => {
            const currentYear = new Date().getFullYear();
            const [year, setYear] = useState(currentYear);
            const [month, setMonth] = useState(new Date().getMonth() + 1);
            const [showRateSettings, setShowRateSettings] = useState(false);
            
            // 讀取 LocalStorage 初始化
            const loadSavedData = () => {
                try {
                    const saved = localStorage.getItem('salaryAppData');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    return {};
                }
            };

            const loadSavedRates = () => {
                try {
                    const saved = localStorage.getItem('salaryAppRates');
                    return saved ? JSON.parse(saved) : { weekday: 196, holiday: 200 };
                } catch (e) {
                    return { weekday: 196, holiday: 200 };
                }
            };

            const [rates, setRates] = useState(loadSavedRates);
            const [workData, setWorkData] = useState(loadSavedData);
            const [isLoaded, setIsLoaded] = useState(false);

            // 當 rates 改變時存檔
            useEffect(() => {
                localStorage.setItem('salaryAppRates', JSON.stringify(rates));
            }, [rates]);

            // 當 workData 改變時存檔
            useEffect(() => {
                if (isLoaded) {
                    localStorage.setItem('salaryAppData', JSON.stringify(workData));
                }
            }, [workData, isLoaded]);

            // 產生 09:00 ~ 23:30 的時間選項
            const timeOptions = useMemo(() => {
                const options = [];
                const startHour = 9; 
                const endHour = 23; 

                for (let i = startHour; i <= endHour; i++) {
                    const hour = String(i).padStart(2, '0');
                    options.push(`${hour}:00`);
                    if (i <= endHour) { 
                        options.push(`${hour}:30`);
                    }
                }
                return options;
            }, []);

            // 初始化邏輯
            useEffect(() => {
                const daysInMonth = new Date(year, month, 0).getDate();
                const newWorkData = { ...workData };
                let hasChanges = false;

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    
                    if (!newWorkData[dateStr]) {
                        const dayOfWeek = new Date(year, month - 1, d).getDay();
                        const isDefaultHoliday = dayOfWeek === 0 || dayOfWeek === 6;
                        
                        newWorkData[dateStr] = {
                            isHoliday: isDefaultHoliday,
                            shifts: [
                                { start: '', end: '' },
                                { start: '', end: '' }
                            ]
                        };
                        hasChanges = true;
                    }
                }
                
                if (hasChanges) {
                    setWorkData(newWorkData);
                }
                setIsLoaded(true);
            }, [year, month]);

            // 清除資料功能
            const handleClearAll = () => {
                if (window.confirm("確定要清除所有資料嗎？\n這將會刪除目前已輸入的工時紀錄，方便您計算下一位員工。")) {
                    setWorkData({}); // 清空資料
                    // 由於 useEffect 依賴 [year, month]，清空後它會在下次 render 時根據目前年月自動補回空白的格子
                    // 但為了即時反應，我們可以在這裡直接重置為當前月份的空白狀態
                    const daysInMonth = new Date(year, month, 0).getDate();
                    const resetData = {};
                    for (let d = 1; d <= daysInMonth; d++) {
                        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        const dayOfWeek = new Date(year, month - 1, d).getDay();
                        const isDefaultHoliday = dayOfWeek === 0 || dayOfWeek === 6;
                        resetData[dateStr] = {
                            isHoliday: isDefaultHoliday,
                            shifts: [{ start: '', end: '' }, { start: '', end: '' }]
                        };
                    }
                    setWorkData(resetData);
                }
            };

            const calculateHours = (start, end) => {
                if (!start || !end || !start.includes(':') || !end.includes(':')) return 0;
                
                const [h1, m1] = start.split(':').map(Number);
                const [h2, m2] = end.split(':').map(Number);
                
                if (isNaN(h1) || isNaN(m1) || isNaN(h2) || isNaN(m2)) return 0;

                const date1 = new Date(0, 0, 0, h1, m1, 0);
                const date2 = new Date(0, 0, 0, h2, m2, 0);
                
                if (date2 < date1) {
                    date2.setDate(date2.getDate() + 1);
                }
                
                const diffMs = date2 - date1;
                const diffHrs = diffMs / 1000 / 60 / 60;
                
                return Math.round(diffHrs * 100) / 100;
            };

            const formatTimeInput = (value) => {
                if (!value) return '';
                let clean = value.replace(/[^\d:]/g, '');
                
                if (!clean.includes(':')) {
                    if (clean.length === 3) {
                        clean = `0${clean.slice(0, 1)}:${clean.slice(1)}`;
                    } else if (clean.length === 4) {
                        clean = `${clean.slice(0, 2)}:${clean.slice(2)}`;
                    }
                }

                const parts = clean.split(':');
                if (parts.length === 2) {
                    let h = parseInt(parts[0]);
                    let m = parseInt(parts[1]);
                    if (!isNaN(h)) parts[0] = String(h).padStart(2, '0');
                    if (!isNaN(m)) parts[1] = String(m).padStart(2, '0');
                    return `${parts[0]}:${parts[1]}`;
                }
                return value;
            };

            const handleTimeBlur = (dateStr, shiftIndex, field, value) => {
                const formatted = formatTimeInput(value);
                if (formatted !== value) {
                    handleTimeChange(dateStr, shiftIndex, field, formatted);
                }
            };

            const handleTimeChange = (dateStr, shiftIndex, field, value) => {
                setWorkData(prev => {
                    const dayData = { ...prev[dateStr] };
                    const newShifts = [...dayData.shifts];
                    newShifts[shiftIndex] = { ...newShifts[shiftIndex], [field]: value };
                    dayData.shifts = newShifts;
                    return { ...prev, [dateStr]: dayData };
                });
            };

            const toggleHoliday = (dateStr) => {
                setWorkData(prev => ({
                    ...prev,
                    [dateStr]: {
                        ...prev[dateStr],
                        isHoliday: !prev[dateStr].isHoliday
                    }
                }));
            };

            const totals = useMemo(() => {
                let weekdayHours = 0;
                let holidayHours = 0;
                let weekdayPay = 0;
                let holidayPay = 0;

                const daysInMonth = new Date(year, month, 0).getDate();
                
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dayData = workData[dateStr];
                    
                    if (dayData) {
                        const h1 = calculateHours(dayData.shifts[0].start, dayData.shifts[0].end);
                        const h2 = calculateHours(dayData.shifts[1].start, dayData.shifts[1].end);
                        const totalDayHours = h1 + h2;

                        if (dayData.isHoliday) {
                            holidayHours += totalDayHours;
                            holidayPay += totalDayHours * rates.holiday;
                        } else {
                            weekdayHours += totalDayHours;
                            weekdayPay += totalDayHours * rates.weekday;
                        }
                    }
                }

                return {
                    weekdayHours,
                    holidayHours,
                    weekdayPay,
                    holidayPay,
                    totalPay: weekdayPay + holidayPay
                };
            }, [workData, year, month, rates]);

            const renderDays = () => {
                const daysInMonth = new Date(year, month, 0).getDate();
                const rows = [];
                const weekDaysZH = ['日', '一', '二', '三', '四', '五', '六'];

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dateObj = new Date(year, month - 1, d);
                    const dayOfWeek = dateObj.getDay();
                    const dayData = workData[dateStr] || { isHoliday: false, shifts: [{start:'', end:''}, {start:'', end:''}] };
                    
                    const h1 = calculateHours(dayData.shifts[0].start, dayData.shifts[0].end);
                    const h2 = calculateHours(dayData.shifts[1].start, dayData.shifts[1].end);
                    const dailyTotal = h1 + h2;
                    const dailyWage = Math.round(dailyTotal * (dayData.isHoliday ? rates.holiday : rates.weekday));

                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    
                    rows.push(
                        <div key={dateStr} className={`p-4 mb-3 rounded-lg border shadow-sm transition-colors ${dayData.isHoliday ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200'}`}>
                            <div className="flex justify-between items-center mb-3">
                                <div className="flex items-center gap-2">
                                    <span className={`text-lg font-bold w-8 text-center ${isWeekend || dayData.isHoliday ? 'text-red-600' : 'text-gray-700'}`}>{d}</span>
                                    <span className={`text-sm px-2 py-0.5 rounded ${isWeekend ? 'bg-red-100 text-red-600' : 'bg-gray-100 text-gray-600'}`}>週{weekDaysZH[dayOfWeek]}</span>
                                </div>
                                <div className="flex items-center gap-3">
                                    <label className="flex items-center cursor-pointer select-none group">
                                        <input 
                                            type="checkbox" 
                                            checked={dayData.isHoliday} 
                                            onChange={() => toggleHoliday(dateStr)}
                                            className="mr-2 h-4 w-4 accent-red-500 cursor-pointer"
                                        />
                                        <span className={`text-sm font-medium group-hover:opacity-80 ${dayData.isHoliday ? 'text-red-600' : 'text-gray-400'}`}>
                                            {dayData.isHoliday ? '假日計薪' : '平日計薪'}
                                        </span>
                                    </label>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <div className="flex items-center gap-2 p-1">
                                    <span className="text-xs text-gray-500 font-bold whitespace-nowrap w-8">時段1</span>
                                    <TimeInput 
                                        value={dayData.shifts[0].start}
                                        onChange={(e) => handleTimeChange(dateStr, 0, 'start', e.target.value)}
                                        onBlur={(e) => handleTimeBlur(dateStr, 0, 'start', e.target.value)}
                                        placeholder="09:00"
                                    />
                                    <span className="text-gray-300">~</span>
                                    <TimeInput 
                                        value={dayData.shifts[0].end}
                                        onChange={(e) => handleTimeChange(dateStr, 0, 'end', e.target.value)}
                                        onBlur={(e) => handleTimeBlur(dateStr, 0, 'end', e.target.value)}
                                        placeholder="18:00"
                                    />
                                    <span className={`text-xs font-bold min-w-[2.5rem] text-right ${h1 > 0 ? 'text-blue-600' : 'text-gray-300'}`}>{h1 > 0 ? h1 + 'h' : '-'}</span>
                                </div>

                                <div className="flex items-center gap-2 p-1">
                                    <span className="text-xs text-gray-500 font-bold whitespace-nowrap w-8">時段2</span>
                                    <TimeInput 
                                        value={dayData.shifts[1].start}
                                        onChange={(e) => handleTimeChange(dateStr, 1, 'start', e.target.value)}
                                        onBlur={(e) => handleTimeBlur(dateStr, 1, 'start', e.target.value)}
                                        placeholder="--"
                                    />
                                    <span className="text-gray-300">~</span>
                                    <TimeInput 
                                        value={dayData.shifts[1].end}
                                        onChange={(e) => handleTimeChange(dateStr, 1, 'end', e.target.value)}
                                        onBlur={(e) => handleTimeBlur(dateStr, 1, 'end', e.target.value)}
                                        placeholder="--"
                                    />
                                    <span className={`text-xs font-bold min-w-[2.5rem] text-right ${h2 > 0 ? 'text-blue-600' : 'text-gray-300'}`}>{h2 > 0 ? h2 + 'h' : '-'}</span>
                                </div>
                            </div>

                            {(h1 > 0 || h2 > 0) && (
                                <div className="flex justify-between items-center text-sm border-t pt-2 mt-1 border-gray-100 animate-fade-in">
                                    <span className="text-gray-500">工時: <span className="font-bold text-gray-800">{dailyTotal}</span> hr</span>
                                    <span className="text-gray-500">試算: <span className="font-bold text-blue-600">${dailyWage.toLocaleString()}</span></span>
                                </div>
                            )}
                        </div>
                    );
                }
                return rows;
            };

            return (
                <div className="min-h-screen pb-36 font-sans">
                    <datalist id="valid-times">
                        {timeOptions.map(time => <option key={time} value={time} />)}
                    </datalist>

                    <div className="bg-white shadow-sm sticky top-0 z-20">
                        <div className="max-w-3xl mx-auto px-4 py-3">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className="text-xl font-bold text-slate-700 flex items-center gap-2">
                                    <CalculatorIcon />
                                    薪資小幫手
                                </h1>
                                <div className="flex gap-2">
                                    <button onClick={handleClearAll} className="text-sm px-3 py-1 bg-red-50 text-red-600 rounded-full hover:bg-red-100 transition-colors flex items-center gap-1 border border-red-200">
                                        <TrashIcon /> 清除
                                    </button>
                                    <button onClick={() => setShowRateSettings(!showRateSettings)} className="text-sm px-3 py-1 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition-colors border border-blue-200">
                                        {showRateSettings ? '關閉設定' : '費率設定'}
                                    </button>
                                </div>
                            </div>

                            {showRateSettings && (
                                <div className="mb-4 p-4 bg-white border border-blue-100 shadow-md rounded-xl text-sm grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-gray-600 mb-1 font-medium">平日時薪</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-1.5 text-gray-400">$</span>
                                            <input type="number" value={rates.weekday} onChange={(e) => setRates({...rates, weekday: Number(e.target.value)})} className="pl-7 w-full p-1.5 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-red-600 mb-1 font-medium">假日時薪</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-1.5 text-gray-400">$</span>
                                            <input type="number" value={rates.holiday} onChange={(e) => setRates({...rates, holiday: Number(e.target.value)})} className="pl-7 w-full p-1.5 border border-red-200 rounded text-red-600 focus:ring-2 focus:ring-red-500 outline-none" />
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="flex gap-2">
                                <div className="relative flex-1">
                                    <select value={year} onChange={(e) => setYear(Number(e.target.value))} className="w-full appearance-none bg-slate-50 border border-slate-300 text-slate-700 py-2.5 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-blue-500 font-medium">
                                        {Array.from({ length: 5 }, (_, i) => currentYear - 2 + i).map(y => <option key={y} value={y}>{y} 年</option>)}
                                    </select>
                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><ChevronDownIcon /></div>
                                </div>
                                <div className="relative flex-1">
                                    <select value={month} onChange={(e) => setMonth(Number(e.target.value))} className="w-full appearance-none bg-slate-50 border border-slate-300 text-slate-700 py-2.5 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-blue-500 font-medium">
                                        {Array.from({ length: 12 }, (_, i) => i + 1).map(m => <option key={m} value={m}>{m} 月</option>)}
                                    </select>
                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><ChevronDownIcon /></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto px-4 py-4 space-y-3">
                        {renderDays()}
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] z-30 safe-area-bottom">
                        <div className="max-w-3xl mx-auto p-4">
                            <div className="flex gap-4 mb-3 text-sm">
                                <div className="flex-1 bg-gray-50 rounded px-3 py-2 border border-gray-100">
                                    <div className="text-gray-500 text-xs mb-1">平日總計 ({totals.weekdayHours}h)</div>
                                    <div className="font-bold text-gray-700 text-lg">${Math.round(totals.weekdayPay).toLocaleString()}</div>
                                </div>
                                <div className="flex-1 bg-red-50 rounded px-3 py-2 border border-red-100">
                                    <div className="text-red-500 text-xs mb-1">假日總計 ({totals.holidayHours}h)</div>
                                    <div className="font-bold text-red-700 text-lg">${Math.round(totals.holidayPay).toLocaleString()}</div>
                                </div>
                            </div>
                            <div className="flex justify-between items-end">
                                <span className="text-gray-600 font-medium pb-1">本月實領薪資</span>
                                <span className="text-3xl font-extrabold text-blue-600 tracking-tight">${Math.round(totals.totalPay).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TaiwanSalaryApp />);
    </script>
</body>
</html>
